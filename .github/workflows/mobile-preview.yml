name: Mobile Preview (Manual)

on:
  workflow_dispatch:

jobs:
  preview:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate NGROK_TOKEN secret
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          if [ -z "$NGROK_TOKEN" ]; then
            echo "NGROK_TOKEN secret is not configured." >&2
            exit 1
          fi

      - name: Start app
        run: |
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &
          for i in {1..30}; do
            if curl --silent --fail http://127.0.0.1:8000/health > /dev/null; then
              echo "Backend is healthy"
              break
            fi
            sleep 1
          done

          if ! curl --silent --fail http://127.0.0.1:8000/health > /dev/null; then
            echo "Backend failed to start. backend.log:" >&2
            cat backend.log >&2
            exit 1
          fi

      - name: Install and configure ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"

          if curl --fail --location --silent --show-error https://ngrok-agent.s3.amazonaws.com/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz; then
            echo "Downloaded ngrok from AWS distribution"
          elif curl --fail --location --silent --show-error https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz; then
            echo "Downloaded ngrok from Equinox CDN fallback"
          elif curl --fail --location --silent --show-error https://github.com/ngrok/ngrok/releases/latest/download/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz; then
            echo "Downloaded ngrok from GitHub Releases fallback"
          else
            echo "Failed to download ngrok from all known sources" >&2
            exit 1
          fi

          tar -xzf ngrok.tgz
          NGROK_BINARY="$(find . -maxdepth 3 -type f -name ngrok | head -n 1)"
          if [ -z "$NGROK_BINARY" ]; then
            echo "ngrok binary was not found in extracted archive" >&2
            exit 1
          fi

          chmod +x "$NGROK_BINARY"
          mv "$NGROK_BINARY" "$HOME/.local/bin/ngrok"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          "$HOME/.local/bin/ngrok" version
          "$HOME/.local/bin/ngrok" config add-authtoken "$NGROK_TOKEN"

      - name: Start ngrok tunnel
        run: |
          nohup ngrok http 8000 --log=stdout > ngrok.log 2>&1 &
          sleep 5
          curl --fail http://127.0.0.1:4040/api/tunnels > tunnels.json
          echo "Public URL(s):"
          python -c "import json; t=json.load(open('tunnels.json')).get('tunnels', []); [print('- ' + x.get('public_url','')) for x in t]; (_ for _ in ()).throw(SystemExit('No ngrok tunnel was created')) if not t else None"

      - name: Keep alive until manually cancelled
        run: |
          echo "Workflow is running for manual/mobile testing."
          echo "Stop it by cancelling this workflow run in GitHub Actions."
          while true; do
            sleep 60
          done
