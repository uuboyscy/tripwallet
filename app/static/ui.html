<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TripWallet MVP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; color: #222; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    h1,h2,h3 { margin: 0 0 12px; }
    input, select, button, textarea { padding: 8px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; border: 0; background: #2463eb; color: #fff; border-radius: 6px; }
    button.secondary { background: #5f6b7a; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 10px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background:#eef3ff; font-size: 12px; }
    .hidden { display:none; }
    pre { background:#111827; color:#e5e7eb; padding:10px; border-radius:8px; overflow:auto; }
    .notice { padding: 10px; border-radius: 8px; margin: 8px 0 12px; font-weight: 600; }
    .notice.success { background: #e8f7ee; color: #146534; }
    .notice.error { background: #fdebec; color: #9f1239; }
    .table-wrap { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 680px; }
    td,th { border-bottom: 1px solid #e6e6e6; text-align: left; padding: 8px; font-size: 14px; word-break: break-word; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TripWallet MVP UI</h1>

    <div class="card" id="auth-card">
      <h2>1) Sign up / Login</h2>
      <div class="grid">
        <div>
          <h3>Sign up</h3>
          <input id="signup-email" placeholder="Email" />
          <input id="signup-name" placeholder="Display Name" />
          <input id="signup-password" placeholder="Password" type="password" />
          <button onclick="signup()">Sign up</button>
        </div>
        <div>
          <h3>Login</h3>
          <input id="login-email" placeholder="Email" />
          <input id="login-password" placeholder="Password" type="password" />
          <button onclick="login()">Login</button>
        </div>
      </div>
      <div id="auth-notice" class="notice hidden" role="status" aria-live="polite"></div>
      <p>Current token: <span class="pill" id="token-state">none</span></p>
    </div>

    <div class="card hidden" id="trip-card">
      <h2>2) Trips</h2>
      <div class="grid">
        <div>
          <h3>Create trip</h3>
          <input id="trip-name" placeholder="Trip name" />
          <input id="trip-base" placeholder="Base currency (JPY)" value="JPY" />
          <button onclick="createTrip()">Create trip</button>
        </div>
        <div>
          <h3>Join by invite code</h3>
          <input id="join-code" placeholder="Invite code" />
          <button onclick="joinTrip()">Join</button>
        </div>
      </div>
      <button class="secondary" onclick="loadTrips()">Reload my trips</button>
      <div id="trip-list"></div>
    </div>

    <div class="card hidden" id="expense-card">
      <h2>3) Expenses + Analytics</h2>
      <label>Selected Trip ID</label>
      <input id="selected-trip-id" placeholder="Select a trip first" />

      <h3>Create invite (owner)</h3>
      <div class="row">
        <input id="invite-hours" type="number" value="24" min="1" />
        <button onclick="createInvite()">Generate Invite</button>
      </div>
      <div id="invite-result"></div>

      <h3>Add expense</h3>
      <div class="grid">
        <input id="expense-amount" placeholder="Amount" type="number" step="0.01" />
        <input id="expense-currency" placeholder="Currency" value="JPY" />
        <input id="expense-fx" placeholder="FX to base (if needed)" type="number" step="0.0001" />
        <input id="expense-category" placeholder="Category" value="food" />
        <input id="expense-time" type="datetime-local" />
        <textarea id="expense-note" placeholder="Note"></textarea>
      </div>
      <button onclick="createExpense()">Create expense</button>

      <h3>Expenses</h3>
      <button class="secondary" onclick="loadExpenses()">Load expenses</button>
      <div class="table-wrap">
        <table id="expense-table"></table>
      </div>

      <h3>Analytics Summary</h3>
      <button class="secondary" onclick="loadAnalytics()">Load analytics</button>
      <pre id="analytics-output">{}</pre>
    </div>

    <div class="card">
      <h2>Logs</h2>
      <pre id="logs"></pre>
    </div>
  </div>

  <script>
    const state = { token: localStorage.getItem('tripwallet_token') || '', trips: [] };

    function log(msg) {
      const el = document.getElementById('logs');
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent;
    }

    function setToken(token) {
      state.token = token;
      localStorage.setItem('tripwallet_token', token);
      document.getElementById('token-state').textContent = token ? 'set' : 'none';
      document.getElementById('trip-card').classList.toggle('hidden', !token);
      document.getElementById('expense-card').classList.toggle('hidden', !token);
    }

    function showAuthNotice(message, kind = 'success') {
      const el = document.getElementById('auth-notice');
      el.textContent = message;
      el.classList.remove('hidden', 'success', 'error');
      el.classList.add(kind);
    }

    function formatDateTime(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return new Intl.DateTimeFormat(undefined, {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      }).format(date);
    }

    async function api(path, method = 'GET', body) {
      const headers = { 'Content-Type': 'application/json' };
      if (state.token) headers.Authorization = `Bearer ${state.token}`;
      const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
      if (!res.ok) throw new Error(`${res.status} ${JSON.stringify(data)}`);
      return data;
    }

    async function signup() {
      try {
        const data = await api('/auth/signup', 'POST', {
          email: document.getElementById('signup-email').value,
          display_name: document.getElementById('signup-name').value,
          password: document.getElementById('signup-password').value,
        });
        setToken(data.access_token);
        log('Signup success');
        showAuthNotice('Sign up complete. You are now logged in.', 'success');
      } catch (e) {
        log(`Signup failed: ${e.message}`);
        showAuthNotice(`Sign up failed: ${e.message}`, 'error');
      }
    }

    async function login() {
      try {
        const data = await api('/auth/login', 'POST', {
          email: document.getElementById('login-email').value,
          password: document.getElementById('login-password').value,
        });
        setToken(data.access_token);
        log('Login success');
        showAuthNotice('Login successful. Welcome back!', 'success');
      } catch (e) {
        log(`Login failed: ${e.message}`);
        showAuthNotice(`Login failed: ${e.message}`, 'error');
      }
    }

    async function createTrip() {
      try {
        await api('/trips', 'POST', {
          name: document.getElementById('trip-name').value,
          base_currency: document.getElementById('trip-base').value,
        });
        log('Trip created');
        loadTrips();
      } catch (e) { log(`Create trip failed: ${e.message}`); }
    }

    async function loadTrips() {
      try {
        state.trips = await api('/trips');
        const list = document.getElementById('trip-list');
        list.innerHTML = state.trips.map(t => `
          <div class="card">
            <div><b>${t.name}</b> <span class="pill">${t.base_currency}</span></div>
            <div>${t.id}</div>
            <button onclick="selectTrip('${t.id}')">Select</button>
          </div>
        `).join('');
        log(`Loaded ${state.trips.length} trip(s)`);
      } catch (e) { log(`Load trips failed: ${e.message}`); }
    }

    function selectTrip(id) {
      document.getElementById('selected-trip-id').value = id;
      log(`Selected trip ${id}`);
    }

    async function createInvite() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const expiresInHours = Number(document.getElementById('invite-hours').value || 24);
        const res = await api(`/trips/${tripId}/invite`, 'POST', { expires_in_hours: expiresInHours });
        document.getElementById('invite-result').textContent = `Code: ${res.invite_code}, expires: ${res.expires_at}`;
        log('Invite generated');
      } catch (e) { log(`Create invite failed: ${e.message}`); }
    }

    async function joinTrip() {
      try {
        const code = document.getElementById('join-code').value;
        await api('/trips/join', 'POST', { invite_code: code });
        log('Join success');
        loadTrips();
      } catch (e) { log(`Join failed: ${e.message}`); }
    }

    async function createExpense() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const localValue = document.getElementById('expense-time').value;
        const iso = localValue ? new Date(localValue).toISOString() : new Date().toISOString();
        const body = {
          amount: String(document.getElementById('expense-amount').value),
          currency: document.getElementById('expense-currency').value,
          category: document.getElementById('expense-category').value,
          expense_time: iso,
          note: document.getElementById('expense-note').value,
        };
        const fx = document.getElementById('expense-fx').value;
        if (fx) body.fx_rate_to_base = String(fx);
        await api(`/trips/${tripId}/expenses`, 'POST', body);
        log('Expense created');
        loadExpenses();
      } catch (e) { log(`Create expense failed: ${e.message}`); }
    }

    async function loadExpenses() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const items = await api(`/trips/${tripId}/expenses`);
        const table = document.getElementById('expense-table');
        table.innerHTML = `<tr><th>time</th><th>amount</th><th>currency</th><th>base</th><th>category</th><th>note</th></tr>` +
          items.map(i => `<tr><td>${formatDateTime(i.expense_time)}</td><td>${i.amount}</td><td>${i.currency}</td><td>${i.amount_in_base}</td><td>${i.category}</td><td>${i.note || ''}</td></tr>`).join('');
        log(`Loaded ${items.length} expense(s)`);
      } catch (e) { log(`Load expenses failed: ${e.message}`); }
    }

    async function loadAnalytics() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const summary = await api(`/trips/${tripId}/analytics/summary`);
        document.getElementById('analytics-output').textContent = JSON.stringify(summary, null, 2);
        log('Analytics loaded');
      } catch (e) { log(`Load analytics failed: ${e.message}`); }
    }

    setToken(state.token);
    if (state.token) loadTrips();
  </script>
</body>
</html>
