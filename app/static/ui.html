<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TripWallet MVP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; color: #222; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    h1,h2,h3,h4 { margin: 0 0 12px; }
    input, select, button, textarea { padding: 8px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    input[type="checkbox"] { width: auto; margin: 0 6px 0 0; }
    button { cursor: pointer; border: 0; background: #2463eb; color: #fff; border-radius: 6px; }
    button.secondary { background: #5f6b7a; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 10px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background:#eef3ff; font-size: 12px; }
    .hidden { display:none; }
    pre { background:#111827; color:#e5e7eb; padding:10px; border-radius:8px; overflow:auto; }
    .notice { padding: 10px; border-radius: 8px; margin: 8px 0 12px; font-weight: 600; }
    .notice.success { background: #e8f7ee; color: #146534; }
    .notice.error { background: #fdebec; color: #9f1239; }

    .expense-list { border: 1px solid #e6e6e6; border-radius: 10px; overflow: hidden; }
    .date-divider { background: #ececec; color: #666; padding: 8px 12px; font-weight: 600; }
    .expense-row { display: flex; justify-content: space-between; gap: 12px; background: #fff; border: 0; border-bottom: 1px solid #efefef; width: 100%; text-align: left; padding: 12px; }
    .expense-row:hover { background: #f8fbff; }
    .expense-row:last-child { border-bottom: 0; }
    .expense-title { font-size: 22px; margin-bottom: 4px; color: #222; font-weight: 700; }
    .expense-subtitle { color: #777; font-size: 14px; }
    .expense-amount { color: #c56868; font-size: 22px; white-space: nowrap; align-self: center; text-align: right; }
    .expense-share-label { color: #888; font-size: 12px; }
    .split-member-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 4px; }
    .split-member-grid label { font-size: 14px; display: flex; align-items: center; gap: 4px; color: #333; }
    .detail-card { border: 1px solid #e6e6e6; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .field-caption { font-size: 13px; color: #666; margin-top: 6px; }
    .hint { font-size: 12px; color: #6b7280; margin: 2px 0 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TripWallet MVP UI</h1>

    <div class="card" id="auth-card">
      <h2>1) Sign up / Login</h2>
      <div class="grid">
        <div>
          <h3>Sign up</h3>
          <input id="signup-email" placeholder="Email" />
          <input id="signup-name" placeholder="Display Name" />
          <input id="signup-password" placeholder="Password" type="password" />
          <button onclick="signup()">Sign up</button>
        </div>
        <div>
          <h3>Login</h3>
          <input id="login-email" placeholder="Email" />
          <input id="login-password" placeholder="Password" type="password" />
          <button onclick="login()">Login</button>
        </div>
      </div>
      <div id="auth-notice" class="notice hidden" role="status" aria-live="polite"></div>
      <p>Current token: <span class="pill" id="token-state">none</span></p>
    </div>

    <div class="card hidden" id="trip-card">
      <h2>2) Trips</h2>
      <div class="grid">
        <div>
          <h3>Create trip</h3>
          <input id="trip-name" placeholder="Trip name" />
          <div class="hint">Enter an easy-to-recognize trip title.</div>
          <select id="trip-base" onchange="toggleCurrencyCustomInput('trip-base', 'trip-base-custom')"></select>
          <input id="trip-base-custom" class="hidden" placeholder="Type custom main currency code" />
          <div class="hint">Pick the trip main currency (final settlement currency).</div>
          <button onclick="createTrip()">Create trip</button>
        </div>
        <div>
          <h3>Join by invite code</h3>
          <input id="join-code" placeholder="Invite code" />
          <div class="hint">Paste the invite code shared by the trip owner.</div>
          <button onclick="joinTrip()">Join</button>
        </div>
      </div>
      <button class="secondary" onclick="loadTrips()">Reload my trips</button>
      <div id="trip-list"></div>
    </div>

    <div class="card hidden" id="expense-card">
      <h2>3) Orders</h2>
      <label>Selected Trip ID</label>
      <input id="selected-trip-id" placeholder="Select a trip first" />

      <h3>Create invite (owner)</h3>
      <div class="row">
        <input id="invite-hours" type="number" value="24" min="1" />
        <button onclick="createInvite()">Generate Invite</button>
      </div>
      <div id="invite-result"></div>

      <h3>Add order</h3>
      <div class="grid">
        <input id="expense-category" placeholder="Order name" value="food" />
        <input id="expense-amount" placeholder="Amount" type="number" step="0.01" />
        <div>
          <select id="expense-currency" onchange="toggleCurrencyCustomInput('expense-currency', 'expense-currency-custom'); updateAutoFxHint()"></select>
          <input id="expense-currency-custom" class="hidden" placeholder="Type custom original currency code" />
          <div class="hint">Original currency that you paid in.</div>
        </div>
        <div>
          <select id="expense-target-currency" onchange="toggleCurrencyCustomInput('expense-target-currency', 'expense-target-currency-custom'); updateAutoFxHint()"></select>
          <input id="expense-target-currency-custom" class="hidden" placeholder="Type custom target currency code" />
          <div class="hint">Currency to convert this order into.</div>
        </div>
        <div>
          <input id="expense-fx" placeholder="FX to trip main currency" type="number" step="0.0001" />
          <div class="hint" id="fx-hint">Default uses latest known rate automatically.</div>
        </div>
        <input id="expense-time" type="datetime-local" />
        <select id="expense-owner"></select>
        <select id="split-mode" onchange="renderSplitFields()">
          <option value="equal">Split equally</option>
          <option value="custom">Split with custom amount</option>
        </select>
        <div id="split-equal-members" class="split-member-grid"></div>
        <textarea id="split-custom" class="hidden" placeholder='Custom split JSON, e.g. {"uuid-1": 120, "uuid-2": 80}'></textarea>
        <textarea id="expense-note" placeholder="Note"></textarea>
        <div class="hint">Optional note: what was this order for?</div>
      </div>
      <button onclick="createExpense()">Create order</button>

      <h3>Order history</h3>
      <button class="secondary" onclick="loadExpenses()">Load orders</button>
      <div id="expense-list" class="expense-list"></div>

      <div id="order-detail" class="detail-card hidden">
        <h4>Order detail</h4>
        <div class="grid">
          <input id="detail-name" placeholder="Order name" />
          <input id="detail-amount" placeholder="Amount" type="number" step="0.01" />
          <select id="detail-owner"></select>
          <input id="detail-time" type="datetime-local" />
          <select id="detail-split-mode" onchange="renderDetailSplitFields()">
            <option value="equal">Split equally</option>
            <option value="custom">Split with custom amount</option>
          </select>
          <div>
            <div class="field-caption">Members who should pay for this order</div>
            <div id="detail-split-members" class="split-member-grid"></div>
          </div>
          <textarea id="detail-split-custom" class="hidden" placeholder='Custom split JSON, e.g. {"uuid-1": 120, "uuid-2": 80}'></textarea>
        </div>
        <button onclick="saveExpenseDetail()">Save changes</button>
      </div>

      <h3>Analytics Summary</h3>
      <button class="secondary" onclick="loadAnalytics()">Load analytics</button>
      <pre id="analytics-output">{}</pre>
    </div>

    <div class="card">
      <h2>Logs</h2>
      <pre id="logs"></pre>
    </div>
  </div>

  <script>
    const KNOWN_CURRENCIES = ['TWD', 'JPY', 'EUR', 'USD', 'GBP', 'CNY'];
    const USD_VALUE_BY_CURRENCY = { TWD: 0.031, JPY: 0.0067, EUR: 1.08, USD: 1, GBP: 1.27, CNY: 0.139 };

    const state = {
      token: localStorage.getItem('tripwallet_token') || '',
      trips: [],
      members: [],
      me: null,
      expenses: [],
      selectedExpenseId: null,
      selectedTrip: null,
    };

    function log(msg) {
      const el = document.getElementById('logs');
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent;
    }

    function setToken(token) {
      state.token = token;
      localStorage.setItem('tripwallet_token', token);
      document.getElementById('token-state').textContent = token ? 'set' : 'none';
      document.getElementById('trip-card').classList.toggle('hidden', !token);
      document.getElementById('expense-card').classList.toggle('hidden', !token);
    }


    function renderCurrencyOptions(selectId, selected = 'USD') {
      const select = document.getElementById(selectId);
      select.innerHTML = `
        ${KNOWN_CURRENCIES.map(code => `<option value="${code}">${code}</option>`).join('')}
        <option value="OTHER">Other (type manually)</option>
      `;
      if ([...KNOWN_CURRENCIES, 'OTHER'].includes(selected)) select.value = selected;
    }

    function toggleCurrencyCustomInput(selectId, customInputId) {
      const select = document.getElementById(selectId);
      const custom = document.getElementById(customInputId);
      const isOther = select.value === 'OTHER';
      custom.classList.toggle('hidden', !isOther);
      if (!isOther) custom.value = '';
    }

    function getCurrencyValue(selectId, customInputId) {
      const selectVal = document.getElementById(selectId).value;
      if (selectVal !== 'OTHER') return selectVal;
      return (document.getElementById(customInputId).value || '').trim().toUpperCase();
    }

    function latestFx(source, target) {
      if (!source || !target) return null;
      const s = USD_VALUE_BY_CURRENCY[source];
      const t = USD_VALUE_BY_CURRENCY[target];
      if (!s || !t) return null;
      return s / t;
    }

    function updateAutoFxHint() {
      const source = getCurrencyValue('expense-currency', 'expense-currency-custom');
      const tripBase = state.selectedTrip?.base_currency;
      const fxHint = document.getElementById('fx-hint');
      const fxInput = document.getElementById('expense-fx');
      const fx = latestFx(source, tripBase);
      if (!fx || !tripBase) {
        fxHint.textContent = 'Default uses latest known rate automatically. Unknown currencies may need manual FX.';
        return;
      }
      fxHint.textContent = `Latest estimate ${source}->${tripBase}: ${fx.toFixed(6)} (editable)`;
      if (!fxInput.value) fxInput.value = fx.toFixed(6);
    }

    function initCurrencyControls() {
      renderCurrencyOptions('trip-base', 'USD');
      renderCurrencyOptions('expense-currency', 'USD');
      renderCurrencyOptions('expense-target-currency', 'USD');
      toggleCurrencyCustomInput('trip-base', 'trip-base-custom');
      toggleCurrencyCustomInput('expense-currency', 'expense-currency-custom');
      toggleCurrencyCustomInput('expense-target-currency', 'expense-target-currency-custom');
    }

    function showAuthNotice(message, kind = 'success') {
      const el = document.getElementById('auth-notice');
      el.textContent = message;
      el.classList.remove('hidden', 'success', 'error');
      el.classList.add(kind);
    }

    function formatDateBlock(value) {
      const date = new Date(value);
      return new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'long', day: 'numeric' }).format(date);
    }

    function formatDateTimeInput(value) {
      const d = new Date(value);
      const tz = d.getTimezoneOffset();
      const local = new Date(d.getTime() - tz * 60000);
      return local.toISOString().slice(0, 16);
    }

    function formatMoney(currency, amount) {
      return `${currency} ${amount}`;
    }

    function renderOwnerOptions() {
      const options = state.members.map(m => `<option value="${m.user_id}">${m.display_name}</option>`).join('');
      document.getElementById('expense-owner').innerHTML = options;
      document.getElementById('detail-owner').innerHTML = options;
      if (state.me) document.getElementById('expense-owner').value = state.me.id;
    }

    function renderSplitFields() {
      const mode = document.getElementById('split-mode').value;
      const equalWrap = document.getElementById('split-equal-members');
      const custom = document.getElementById('split-custom');
      equalWrap.classList.toggle('hidden', mode !== 'equal');
      custom.classList.toggle('hidden', mode !== 'custom');
      equalWrap.innerHTML = state.members.map(m => `<label><input type="checkbox" class="split-member" value="${m.user_id}" checked/>${m.display_name}</label>`).join('');
    }

    
    function renderDetailSplitFields(selectedIds = null) {
      const mode = document.getElementById('detail-split-mode').value;
      const membersWrap = document.getElementById('detail-split-members');
      const custom = document.getElementById('detail-split-custom');
      custom.classList.toggle('hidden', mode !== 'custom');
      const selected = new Set(selectedIds || state.members.map(m => m.user_id));
      membersWrap.innerHTML = state.members.map(m => `<label><input type="checkbox" class="detail-split-member" value="${m.user_id}" ${selected.has(m.user_id) ? 'checked' : ''}/> ${m.display_name}</label>`).join('');
    }

    function userNameById(userId) {
      const found = state.members.find(m => m.user_id === userId);
      return found ? found.display_name : userId;
    }


    function myShareAmount(order) {
      if (!state.me) return '0';
      const myId = state.me.id;
      if (order.split_mode === 'custom') {
        const custom = order.custom_split_amounts || {};
        return String(custom[myId] ?? custom[String(myId)] ?? '0');
      }

      const participants = order.split_with_user_ids || [];
      if (!participants.includes(myId) || participants.length === 0) return '0';
      const total = Number(order.amount);
      if (Number.isNaN(total)) return '0';
      const share = total / participants.length;
      return Number.isInteger(share) ? String(share) : share.toFixed(2);
    }

    function groupedExpenses(items) {
      const map = new Map();
      const sorted = [...items].sort((a, b) => new Date(b.expense_time) - new Date(a.expense_time));
      for (const item of sorted) {
        const key = new Date(item.expense_time).toISOString().slice(0, 10);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      }
      return map;
    }

    function renderExpenseList() {
      const wrap = document.getElementById('expense-list');
      if (!state.expenses.length) {
        wrap.innerHTML = '<div class="date-divider">No orders yet.</div>';
        return;
      }
      const groups = groupedExpenses(state.expenses);
      const chunks = [];
      for (const [dateKey, items] of groups.entries()) {
        chunks.push(`<div class="date-divider">${formatDateBlock(dateKey)}</div>`);
        for (const i of items) {
          chunks.push(`
            <button class="expense-row" onclick="openExpenseDetail('${i.id}')">
              <div>
                <div class="expense-title">${i.category || 'Untitled order'}</div>
                <div class="expense-subtitle">${userNameById(i.paid_by_user_id)} paid ${formatMoney(i.currency, i.amount)} (original) â†’ ${formatMoney(i.target_currency, i.amount_in_target)}</div>
              </div>
              <div class="expense-amount">${formatMoney(i.currency, myShareAmount(i))}<div class="expense-share-label">your share</div></div>
            </button>
          `);
        }
      }
      wrap.innerHTML = chunks.join('');
    }

    function openExpenseDetail(expenseId) {
      const detailPanel = document.getElementById('order-detail');
      if (state.selectedExpenseId === expenseId && !detailPanel.classList.contains('hidden')) {
        state.selectedExpenseId = null;
        detailPanel.classList.add('hidden');
        return;
      }

      const item = state.expenses.find(e => e.id === expenseId);
      if (!item) return;
      state.selectedExpenseId = expenseId;
      document.getElementById('detail-name').value = item.category;
      document.getElementById('detail-amount').value = item.amount;
      document.getElementById('detail-owner').value = item.owner_user_id;
      document.getElementById('detail-time').value = formatDateTimeInput(item.expense_time);
      document.getElementById('detail-split-mode').value = item.split_mode || 'equal';
      renderDetailSplitFields(item.split_with_user_ids || []);
      document.getElementById('detail-split-custom').value = item.custom_split_amounts ? JSON.stringify(item.custom_split_amounts, null, 2) : '';
      detailPanel.classList.remove('hidden');
    }

    async function saveExpenseDetail() {
      try {
        if (!state.selectedExpenseId) return;
        const tripId = document.getElementById('selected-trip-id').value;
        const localValue = document.getElementById('detail-time').value;
        const splitMode = document.getElementById('detail-split-mode').value;
        const body = {
          category: document.getElementById('detail-name').value,
          amount: String(document.getElementById('detail-amount').value),
          owner_user_id: document.getElementById('detail-owner').value,
          expense_time: new Date(localValue).toISOString(),
          split_mode: splitMode,
          split_with_user_ids: Array.from(document.querySelectorAll('.detail-split-member:checked')).map(el => el.value),
        };
        if (splitMode === 'custom') {
          const raw = document.getElementById('detail-split-custom').value.trim();
          body.custom_split_amounts = raw ? JSON.parse(raw) : {};
        }
        await api(`/trips/${tripId}/expenses/${state.selectedExpenseId}`, 'PATCH', body);
        log('Order updated');
        await loadExpenses();
      } catch (e) {
        log(`Update order failed: ${e.message}`);
      }
    }

    async function loadTripMembers(tripId) {
      state.me = await api('/me');
      state.members = await api(`/trips/${tripId}/members`);
      renderOwnerOptions();
      renderSplitFields();
      renderDetailSplitFields();
    }

    async function api(path, method = 'GET', body) {
      const headers = { 'Content-Type': 'application/json' };
      if (state.token) headers.Authorization = `Bearer ${state.token}`;
      const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
      if (!res.ok) throw new Error(`${res.status} ${JSON.stringify(data)}`);
      return data;
    }

    async function signup() {
      try {
        const data = await api('/auth/signup', 'POST', {
          email: document.getElementById('signup-email').value,
          display_name: document.getElementById('signup-name').value,
          password: document.getElementById('signup-password').value,
        });
        setToken(data.access_token);
        log('Signup success');
        showAuthNotice('Sign up complete. You are now logged in.', 'success');
      } catch (e) {
        log(`Signup failed: ${e.message}`);
        showAuthNotice(`Sign up failed: ${e.message}`, 'error');
      }
    }

    async function login() {
      try {
        const data = await api('/auth/login', 'POST', {
          email: document.getElementById('login-email').value,
          password: document.getElementById('login-password').value,
        });
        setToken(data.access_token);
        log('Login success');
        showAuthNotice('Login successful. Welcome back!', 'success');
      } catch (e) {
        log(`Login failed: ${e.message}`);
        showAuthNotice(`Login failed: ${e.message}`, 'error');
      }
    }

    async function createTrip() {
      try {
        await api('/trips', 'POST', {
          name: document.getElementById('trip-name').value,
          base_currency: getCurrencyValue('trip-base', 'trip-base-custom'),
        });
        log('Trip created');
        loadTrips();
      } catch (e) { log(`Create trip failed: ${e.message}`); }
    }

    async function loadTrips() {
      try {
        state.trips = await api('/trips');
        const list = document.getElementById('trip-list');
        list.innerHTML = state.trips.map(t => `
          <div class="card">
            <div><b>${t.name}</b> <span class="pill">${t.base_currency}</span></div>
            <div>${t.id}</div>
            <button onclick="selectTrip('${t.id}')">Select</button>
          </div>
        `).join('');
        log(`Loaded ${state.trips.length} trip(s)`);
      } catch (e) { log(`Load trips failed: ${e.message}`); }
    }

    async function selectTrip(id) {
      document.getElementById('selected-trip-id').value = id;
      state.selectedTrip = state.trips.find(t => t.id === id) || null;
      if (state.selectedTrip) {
        const base = state.selectedTrip.base_currency;
        const targetSelect = document.getElementById('expense-target-currency');
        if (KNOWN_CURRENCIES.includes(base)) {
          targetSelect.value = base;
          toggleCurrencyCustomInput('expense-target-currency', 'expense-target-currency-custom');
        } else {
          targetSelect.value = 'OTHER';
          document.getElementById('expense-target-currency-custom').value = base;
          toggleCurrencyCustomInput('expense-target-currency', 'expense-target-currency-custom');
        }
      }
      updateAutoFxHint();
      await loadTripMembers(id);
      await loadExpenses();
      log(`Selected trip ${id}`);
    }

    async function createInvite() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const expiresInHours = Number(document.getElementById('invite-hours').value || 24);
        const res = await api(`/trips/${tripId}/invite`, 'POST', { expires_in_hours: expiresInHours });
        document.getElementById('invite-result').textContent = `Code: ${res.invite_code}, expires: ${res.expires_at}`;
        log('Invite generated');
      } catch (e) { log(`Create invite failed: ${e.message}`); }
    }

    async function joinTrip() {
      try {
        const code = document.getElementById('join-code').value;
        await api('/trips/join', 'POST', { invite_code: code });
        log('Join success');
        loadTrips();
      } catch (e) { log(`Join failed: ${e.message}`); }
    }

    async function createExpense() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const localValue = document.getElementById('expense-time').value;
        const iso = localValue ? new Date(localValue).toISOString() : new Date().toISOString();
        const splitMode = document.getElementById('split-mode').value;
        const body = {
          amount: String(document.getElementById('expense-amount').value),
          currency: getCurrencyValue('expense-currency', 'expense-currency-custom'),
          target_currency: getCurrencyValue('expense-target-currency', 'expense-target-currency-custom'),
          category: document.getElementById('expense-category').value,
          expense_time: iso,
          owner_user_id: document.getElementById('expense-owner').value || undefined,
          split_mode: splitMode,
          note: document.getElementById('expense-note').value,
        };
        body.split_with_user_ids = Array.from(document.querySelectorAll('.split-member:checked')).map(el => el.value);
        if (splitMode === 'custom') {
          const raw = document.getElementById('split-custom').value.trim();
          body.custom_split_amounts = raw ? JSON.parse(raw) : {};
        }
        const fx = document.getElementById('expense-fx').value;
        if (fx) body.fx_rate_to_base = String(fx);
        await api(`/trips/${tripId}/expenses`, 'POST', body);
        log('Order created');
        await loadExpenses();
      } catch (e) { log(`Create order failed: ${e.message}`); }
    }

    async function loadExpenses() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        state.expenses = await api(`/trips/${tripId}/expenses`);
        renderExpenseList();
        log(`Loaded ${state.expenses.length} order(s)`);
      } catch (e) { log(`Load orders failed: ${e.message}`); }
    }

    async function loadAnalytics() {
      try {
        const tripId = document.getElementById('selected-trip-id').value;
        const summary = await api(`/trips/${tripId}/analytics/summary`);
        document.getElementById('analytics-output').textContent = JSON.stringify(summary, null, 2);
        log('Analytics loaded');
      } catch (e) { log(`Load analytics failed: ${e.message}`); }
    }

    initCurrencyControls();
    setToken(state.token);
    if (state.token) loadTrips();
  </script>
</body>
</html>
